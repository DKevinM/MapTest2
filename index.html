const axios = require('axios');
const fs = require('fs');
const AdmZip = require('adm-zip');
const shapefile = require('shapefile');

async function automateProcess() {
    // Step 1: Download the Shapefile
    const url = 'https://eer.cmc.ec.gc.ca/mandats/AutoSim/Fire/latest/Canada/latest/shp/shp_Canada.zip';
    const path = './shp_Canada.zip';

    await axios({
        method: 'GET',
        url: url,
        responseType: 'stream',
    }).then(response => {
        response.data.pipe(fs.createWriteStream(path));
        return new Promise((resolve, reject) => {
            response.data.on('end', () => resolve('File downloaded successfully'));
            response.data.on('error', reject);
        });
    });

    // Step 2: Extract the Shapefile
    const zip = new AdmZip(path);
    zip.extractAllTo('./shapefiles', true);

    // Step 3: Convert Shapefile to GeoJSON
    const source = './shapefiles/shp_Canada.shp';
    const destination = './shapefiles/canada.geojson';

    await shapefile.open(source)
        .then(source => source.read()
            .then(function log(result) {
                if (result.done) return;
                fs.writeFileSync(destination, JSON.stringify(result.value));
                return source.read().then(log);
            }))
        .catch(console.error);

    console.log('Process completed successfully');
}

automateProcess().catch(console.error);
